// src/hooks/useSupabase.ts - Vers√£o Completa Melhorada
import { useState, useEffect } from 'react';
import { supabase } from '../lib/supabase';

export const useSupabase = () => {
  const [vendedores, setVendedores] = useState<any[]>([]);
  const [produtos, setProdutos] = useState<any[]>([]);
  const [categorias, setCategorias] = useState<any[]>([]);
  const [consignacoes, setConsignacoes] = useState<any[]>([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  // ========================================
  // FUN√á√ïES UTILIT√ÅRIAS DE ERRO E VALIDA√á√ÉO
  // ========================================
  const tratarErro = (erro: any, operacao: string) => {
    console.error(`‚ùå Erro na opera√ß√£o: ${operacao}`, erro);
    
    let mensagem = `Erro ao ${operacao}`;
    
    if (erro?.message) {
      if (erro.message.includes('column') && erro.message.includes('does not exist')) {
        mensagem = `Erro de schema: Coluna n√£o existe no banco. Execute o SQL de corre√ß√£o.`;
      } else if (erro.message.includes('JWT') || erro.message.includes('Invalid API key')) {
        mensagem = 'Erro de autentica√ß√£o. Verifique as credenciais do Supabase no arquivo .env';
      } else if (erro.message.includes('violates')) {
        mensagem = 'Dados inv√°lidos ou duplicados.';
      } else if (erro.message.includes('relation') && erro.message.includes('does not exist')) {
        mensagem = 'Tabela n√£o existe no banco. Verifique o schema do Supabase.';
      } else {
        mensagem = erro.message;
      }
    }
    
    setError(mensagem);
    return { success: false, error: mensagem };
  };

  const validarDados = (dados: any, tipo: string) => {
    const erros: string[] = [];
    
    switch (tipo) {
      case 'vendedor':
        if (!dados.nome?.trim()) erros.push('Nome do vendedor √© obrigat√≥rio');
        if (!dados.email?.trim()) erros.push('Email √© obrigat√≥rio');
        if (!dados.login?.trim()) erros.push('Login √© obrigat√≥rio');
        if (!dados.senha?.trim()) erros.push('Senha √© obrigat√≥ria');
        break;
        
      case 'produto':
        if (!dados.nome?.trim()) erros.push('Nome do produto √© obrigat√≥rio');
        if (!dados.categoria?.trim()) erros.push('Categoria √© obrigat√≥ria');
        if (!dados.valor_venda && !dados.valorVenda) erros.push('Valor de venda √© obrigat√≥rio');
        break;
        
      case 'categoria':
        if (!dados.nome?.trim()) erros.push('Nome da categoria √© obrigat√≥rio');
        break;
        
      case 'consignacao':
        if (!dados.clienteNome?.trim() && !dados.cliente_nome?.trim()) erros.push('Nome do cliente √© obrigat√≥rio');
        if (!dados.clienteDocumento?.trim() && !dados.cliente_documento?.trim()) erros.push('Documento do cliente √© obrigat√≥rio');
        if (!dados.vendedorId && !dados.vendedor_id) erros.push('Vendedor √© obrigat√≥rio');
        break;
    }
    
    if (erros.length > 0) {
      throw new Error(erros.join(', '));
    }
  };

  // ========================================
  // FUN√á√ÉO DE LOGIN
  // ========================================
  const fazerLogin = async (login: string, senha: string) => {
    try {
      setLoading(true);
      console.log('üîê Tentando login com:', login);
      
      if (!login?.trim() || !senha?.trim()) {
        console.error('‚ùå Login ou senha vazios');
        return null;
      }
      
      const { data, error: err } = await supabase
        .from('vendedores')
        .select('*')
        .eq('login', login.trim())
        .eq('senha', senha.trim())
        .eq('status', 'Ativo')
        .single();

      if (err || !data) {
        console.error('‚ùå Erro no login:', err?.message || 'Credenciais inv√°lidas');
        return null;
      }

      console.log('‚úÖ Login bem-sucedido:', data.nome);
      return data;
    } catch (error: any) {
      console.error('‚ùå Erro cr√≠tico no login:', error);
      tratarErro(error, 'fazer login');
      return null;
    } finally {
      setLoading(false);
    }
  };

  // ========================================
  // VENDEDORES - CRUD COMPLETO
  // ========================================
  const fetchVendedores = async () => {
    try {
      setLoading(true);
      console.log('üîÑ Carregando vendedores...');
      
      const { data, error: err } = await supabase
        .from('vendedores')
        .select('*')
        .order('nome');
      
      if (err) throw err;
      
      setVendedores(data || []);
      console.log('‚úÖ Vendedores carregados:', data?.length);
    } catch (err: any) {
      tratarErro(err, 'carregar vendedores');
    } finally {
      setLoading(false);
    }
  };

  const adicionarVendedor = async (vendedor: any) => {
    try {
      console.log('‚ûï Adicionando vendedor:', vendedor);
      
      // Validar dados
      validarDados(vendedor, 'vendedor');
      
      const vendedorFormatado = {
        nome: String(vendedor.nome || '').trim(),
        email: String(vendedor.email || '').trim().toLowerCase(),
        telefone: String(vendedor.telefone || '').trim(),
        status: vendedor.status || 'Ativo',
        login: String(vendedor.login || '').trim(),
        senha: String(vendedor.senha || '').trim(),
        data_cadastro: new Date().toISOString().split('T')[0]
      };

      console.log('üì§ Dados formatados:', vendedorFormatado);

      const { data, error: err } = await supabase
        .from('vendedores')
        .insert([vendedorFormatado])
        .select();

      if (err) throw err;
      
      console.log('‚úÖ Vendedor adicionado:', data);
      await fetchVendedores();
      return { success: true, data: data || [] };
    } catch (err: any) {
      return tratarErro(err, 'adicionar vendedor');
    }
  };

  const atualizarVendedor = async (id: any, updates: any) => {
    try {
      console.log('‚úèÔ∏è Atualizando vendedor:', id, updates);
      
      if (!id) throw new Error('ID do vendedor √© obrigat√≥rio');
      
      // Preparar dados para atualiza√ß√£o
      const dadosFormatados = {
        nome: updates.nome ? String(updates.nome).trim() : undefined,
        email: updates.email ? String(updates.email).trim().toLowerCase() : undefined,
        telefone: updates.telefone ? String(updates.telefone).trim() : undefined,
        status: updates.status || undefined,
        login: updates.login ? String(updates.login).trim() : undefined,
        senha: updates.senha ? String(updates.senha).trim() : undefined
      };

      // Remover propriedades undefined
      const dadosLimpos = Object.fromEntries(
        Object.entries(dadosFormatados).filter(([_, value]) => value !== undefined)
      );

      if (Object.keys(dadosLimpos).length === 0) {
        throw new Error('Nenhum dado v√°lido para atualizar');
      }

      const { data, error: err } = await supabase
        .from('vendedores')
        .update(dadosLimpos)
        .eq('id', id)
        .select();

      if (err) throw err;
      
      console.log('‚úÖ Vendedor atualizado:', data);
      await fetchVendedores();
      return { success: true, data: data || [] };
    } catch (err: any) {
      return tratarErro(err, 'atualizar vendedor');
    }
  };

  const excluirVendedor = async (id: any) => {
    try {
      console.log('üóëÔ∏è Excluindo vendedor:', id);
      
      if (!id) throw new Error('ID do vendedor √© obrigat√≥rio');
      
      const { error: err } = await supabase
        .from('vendedores')
        .delete()
        .eq('id', id);

      if (err) throw err;
      
      console.log('‚úÖ Vendedor exclu√≠do');
      await fetchVendedores();
      return { success: true };
    } catch (err: any) {
      return tratarErro(err, 'excluir vendedor');
    }
  };

  // ========================================
  // PRODUTOS - CRUD COMPLETO
  // ========================================
  const fetchProdutos = async () => {
    try {
      setLoading(true);
      console.log('üîÑ Carregando produtos...');
      
      const { data, error: err } = await supabase
        .from('produtos')
        .select('*')
        .order('nome');
      
      if (err) throw err;
      
      setProdutos(data || []);
      console.log('‚úÖ Produtos carregados:', data?.length);
    } catch (err: any) {
      tratarErro(err, 'carregar produtos');
    } finally {
      setLoading(false);
    }
  };

  const adicionarProduto = async (produto: any) => {
    try {
      console.log('‚ûï Adicionando produto:', produto);
      
      // Validar dados
      validarDados(produto, 'produto');
      
      // Mapear campos do frontend (camelCase) para o banco (snake_case)
      const produtoFormatado = {
        nome: String(produto.nome || '').trim(),
        descricao: String(produto.descricao || '').trim(),
        codigo_barras: String(produto.codigoBarras || produto.codigo_barras || '').trim(),
        categoria: String(produto.categoria || '').trim(),
        valor_custo: parseFloat(produto.valorCusto || produto.valor_custo || 0),
        valor_venda: parseFloat(produto.valorVenda || produto.valor_venda || 0),
        estoque: parseInt(produto.estoque || 0),
        estoque_minimo: parseInt(produto.estoqueMinimo || produto.estoque_minimo || 0),
        ativo: produto.ativo !== false,
        data_cadastro: new Date().toISOString().split('T')[0]
      };

      console.log('üì§ Produto formatado:', produtoFormatado);

      const { data, error: err } = await supabase
        .from('produtos')
        .insert([produtoFormatado])
        .select();

      if (err) throw err;
      
      console.log('‚úÖ Produto adicionado:', data);
      await fetchProdutos();
      return { success: true, data: data || [] };
    } catch (err: any) {
      return tratarErro(err, 'adicionar produto');
    }
  };

  const atualizarProduto = async (id: any, updates: any) => {
    try {
      console.log('‚úèÔ∏è Atualizando produto:', id, updates);
      
      if (!id) throw new Error('ID do produto √© obrigat√≥rio');
      
      // Mapear campos se necess√°rio
      const produtoFormatado = {
        nome: updates.nome ? String(updates.nome).trim() : undefined,
        descricao: updates.descricao ? String(updates.descricao).trim() : undefined,
        codigo_barras: updates.codigoBarras || updates.codigo_barras || undefined,
        categoria: updates.categoria ? String(updates.categoria).trim() : undefined,
        valor_custo: updates.valorCusto || updates.valor_custo ? parseFloat(updates.valorCusto || updates.valor_custo) : undefined,
        valor_venda: updates.valorVenda || updates.valor_venda ? parseFloat(updates.valorVenda || updates.valor_venda) : undefined,
        estoque: updates.estoque !== undefined ? parseInt(updates.estoque) : undefined,
        estoque_minimo: updates.estoqueMinimo || updates.estoque_minimo !== undefined ? parseInt(updates.estoqueMinimo || updates.estoque_minimo) : undefined,
        ativo: updates.ativo !== undefined ? updates.ativo : undefined
      };

      // Remover propriedades undefined
      const dadosLimpos = Object.fromEntries(
        Object.entries(produtoFormatado).filter(([_, value]) => value !== undefined)
      );

      if (Object.keys(dadosLimpos).length === 0) {
        throw new Error('Nenhum dado v√°lido para atualizar');
      }

      const { data, error: err } = await supabase
        .from('produtos')
        .update(dadosLimpos)
        .eq('id', id)
        .select();

      if (err) throw err;
      
      console.log('‚úÖ Produto atualizado:', data);
      await fetchProdutos();
      return { success: true, data: data || [] };
    } catch (err: any) {
      return tratarErro(err, 'atualizar produto');
    }
  };

  const excluirProduto = async (id: any) => {
    try {
      console.log('üóëÔ∏è Excluindo produto:', id);
      
      if (!id) throw new Error('ID do produto √© obrigat√≥rio');
      
      const { error: err } = await supabase
        .from('produtos')
        .delete()
        .eq('id', id);

      if (err) throw err;
      
      console.log('‚úÖ Produto exclu√≠do');
      await fetchProdutos();
      return { success: true };
    } catch (err: any) {
      return tratarErro(err, 'excluir produto');
    }
  };

  // ========================================
  // CATEGORIAS - CRUD COMPLETO
  // ========================================
  const fetchCategorias = async () => {
    try {
      setLoading(true);
      console.log('üîÑ Carregando categorias...');
      
      const { data, error: err } = await supabase
        .from('categorias')
        .select('*')
        .order('nome');
      
      if (err) throw err;
      
      setCategorias(data || []);
      console.log('‚úÖ Categorias carregadas:', data?.length);
    } catch (err: any) {
      tratarErro(err, 'carregar categorias');
    } finally {
      setLoading(false);
    }
  };

  const adicionarCategoria = async (categoria: any) => {
    try {
      console.log('‚ûï Adicionando categoria:', categoria);
      
      // Validar dados
      validarDados(categoria, 'categoria');
      
      const categoriaFormatada = {
        nome: String(categoria.nome || '').trim(),
        descricao: String(categoria.descricao || '').trim(),
        cor: categoria.cor || '#3B82F6',
        ativa: categoria.ativa !== false,
        data_cadastro: new Date().toISOString().split('T')[0]
      };

      console.log('üì§ Categoria formatada:', categoriaFormatada);

      const { data, error: err } = await supabase
        .from('categorias')
        .insert([categoriaFormatada])
        .select();

      if (err) throw err;
      
      console.log('‚úÖ Categoria adicionada:', data);
      await fetchCategorias();
      return { success: true, data: data || [] };
    } catch (err: any) {
      return tratarErro(err, 'adicionar categoria');
    }
  };

  const atualizarCategoria = async (id: any, updates: any) => {
    try {
      console.log('‚úèÔ∏è Atualizando categoria:', id, updates);
      
      if (!id) throw new Error('ID da categoria √© obrigat√≥rio');
      
      // Preparar dados para atualiza√ß√£o
      const dadosFormatados = {
        nome: updates.nome ? String(updates.nome).trim() : undefined,
        descricao: updates.descricao ? String(updates.descricao).trim() : undefined,
        cor: updates.cor || undefined,
        ativa: updates.ativa !== undefined ? updates.ativa : undefined
      };

      // Remover propriedades undefined
      const dadosLimpos = Object.fromEntries(
        Object.entries(dadosFormatados).filter(([_, value]) => value !== undefined)
      );

      if (Object.keys(dadosLimpos).length === 0) {
        throw new Error('Nenhum dado v√°lido para atualizar');
      }

      const { data, error: err } = await supabase
        .from('categorias')
        .update(dadosLimpos)
        .eq('id', id)
        .select();

      if (err) throw err;
      
      console.log('‚úÖ Categoria atualizada:', data);
      await fetchCategorias();
      return { success: true, data: data || [] };
    } catch (err: any) {
      return tratarErro(err, 'atualizar categoria');
    }
  };

  const excluirCategoria = async (id: any) => {
    try {
      console.log('üóëÔ∏è Excluindo categoria:', id);
      
      if (!id) throw new Error('ID da categoria √© obrigat√≥rio');
      
      const { error: err } = await supabase
        .from('categorias')
        .delete()
        .eq('id', id);

      if (err) throw err;
      
      console.log('‚úÖ Categoria exclu√≠da');
      await fetchCategorias();
      return { success: true };
    } catch (err: any) {
      return tratarErro(err, 'excluir categoria');
    }
  };

  // ========================================
  // CONSIGNA√á√ïES - CRUD COMPLETO
  // ========================================
  const fetchConsignacoes = async () => {
    try {
      setLoading(true);
      console.log('üîÑ Carregando consigna√ß√µes...');
      
      const { data, error: err } = await supabase
        .from('consignacoes')
        .select(`
          *,
          vendedores (
            id,
            nome,
            email
          )
        `)
        .order('data_consignacao', { ascending: false });
      
      if (err) throw err;
      
      setConsignacoes(data || []);
      console.log('‚úÖ Consigna√ß√µes carregadas:', data?.length);
    } catch (err: any) {
      tratarErro(err, 'carregar consigna√ß√µes');
    } finally {
      setLoading(false);
    }
  };

  const adicionarConsignacao = async (consignacao: any) => {
    try {
      console.log('‚ûï Adicionando consigna√ß√£o:', consignacao);
      
      // Validar dados
      validarDados(consignacao, 'consignacao');
      
      // Preparar dados com todos os campos corretos
      const consignacaoFormatada = {
        cliente_nome: String(consignacao.clienteNome || '').trim(),
        cliente_documento: String(consignacao.clienteDocumento || '').replace(/\D/g, ''),
        cliente_telefone: String(consignacao.clienteTelefone || '').trim(),
        tipo_documento: consignacao.tipoDocumento || 'cpf',
        vendedor_id: parseInt(consignacao.vendedorId) || null,
        quantidade_total: parseInt(consignacao.quantidadeTotal) || 0,
        valor_total: parseFloat(consignacao.valorTotal) || 0,
        data_consignacao: new Date().toISOString().split('T')[0],
        data_retorno: null,
        status: 'ativa',
        observacoes: consignacao.observacoes || null,
        retorno: null
      };

      console.log('üì§ Dados formatados para envio:', JSON.stringify(consignacaoFormatada, null, 2));

      const { data, error: err } = await supabase
        .from('consignacoes')
        .insert([consignacaoFormatada])
        .select(`
          *,
          vendedores (
            id,
            nome,
            email
          )
        `);

      if (err) throw err;
      
      console.log('‚úÖ Consigna√ß√£o adicionada com sucesso:', data);
      await fetchConsignacoes();
      return { success: true, data: data || [] };
    } catch (err: any) {
      return tratarErro(err, 'adicionar consigna√ß√£o');
    }
  };

  const finalizarConsignacao = async (id: any, dadosRetorno: any) => {
    try {
      console.log('üèÅ Finalizando consigna√ß√£o ID:', id);
      console.log('üìä Dados do retorno:', dadosRetorno);
      
      if (!id) throw new Error('ID da consigna√ß√£o √© obrigat√≥rio');
      
      // Preparar o objeto JSON para a coluna retorno
      const retornoJson = {
        quantidadeRetornada: parseInt(dadosRetorno.quantidadeRetornada) || 0,
        quantidadeVendida: parseInt(dadosRetorno.quantidadeVendida) || 0,
        valorRetornado: parseFloat(dadosRetorno.valorRetornado) || 0,
        valorDevido: parseFloat(dadosRetorno.valorDevido) || 0,
        observacoes: dadosRetorno.observacoes || '',
        dataFinalizacao: new Date().toISOString()
      };

      const updates = {
        status: 'finalizada',
        data_retorno: new Date().toISOString().split('T')[0],
        retorno: retornoJson
      };

      console.log('üì§ Updates para envio:', JSON.stringify(updates, null, 2));

      const { data, error: err } = await supabase
        .from('consignacoes')
        .update(updates)
        .eq('id', id)
        .select(`
          *,
          vendedores (
            id,
            nome,
            email
          )
        `);

      if (err) throw err;
      
      console.log('‚úÖ Consigna√ß√£o finalizada:', data);
      await fetchConsignacoes();
      return { success: true, data: data || [] };
    } catch (err: any) {
      return tratarErro(err, 'finalizar consigna√ß√£o');
    }
  };

  const excluirConsignacao = async (id: any) => {
    try {
      console.log('üóëÔ∏è Excluindo consigna√ß√£o:', id);
      
      if (!id) throw new Error('ID da consigna√ß√£o √© obrigat√≥rio');
      
      const { error: err } = await supabase
        .from('consignacoes')
        .delete()
        .eq('id', id);

      if (err) throw err;
      
      console.log('‚úÖ Consigna√ß√£o exclu√≠da');
      await fetchConsignacoes();
      return { success: true };
    } catch (err: any) {
      return tratarErro(err, 'excluir consigna√ß√£o');
    }
  };

  // ========================================
  // FUN√á√ÉO PARA RECARREGAR TODOS OS DADOS
  // ========================================
  const refetch = async () => {
    console.log('üîÑ Recarregando todos os dados...');
    setError(null); // Limpar erros anteriores
    
    try {
      await Promise.all([
        fetchVendedores(),
        fetchProdutos(),
        fetchCategorias(),
        fetchConsignacoes()
      ]);
      console.log('‚úÖ Todos os dados recarregados com sucesso');
    } catch (error: any) {
      console.error('‚ùå Erro ao recarregar dados:', error);
      tratarErro(error, 'recarregar dados');
    }
  };

  // ========================================
  // TESTE DE CONEX√ÉO
  // ========================================
  const testarConexao = async () => {
    try {
      console.log('üîç Testando conex√£o com Supabase...');
      
      const { data, error } = await supabase
        .from('vendedores')
        .select('count')
        .limit(1);
      
      if (error) throw error;
      
      console.log('‚úÖ Conex√£o OK!');
      return true;
    } catch (err: any) {
      console.error('‚ùå Falha na conex√£o:', err);
      tratarErro(err, 'testar conex√£o');
      return false;
    }
  };

  // ========================================
  // INICIALIZA√á√ÉO AUTOM√ÅTICA
  // ========================================
  useEffect(() => {
    const inicializar = async () => {
      console.log('üöÄ Inicializando useSupabase...');
      
      // Testar conex√£o primeiro
      const conexaoOk = await testarConexao();
      
      if (conexaoOk) {
        // Carregar todos os dados
        await refetch();
      } else {
        console.error('‚ùå Falha na inicializa√ß√£o - problemas de conex√£o');
      }
    };
    
    inicializar();
  }, []);

  // ========================================
  // RETORNO DO HOOK
  // ========================================
  return {
    // Estados
    vendedores,
    produtos,
    categorias,
    consignacoes,
    loading,
    error,
    
    // Fun√ß√£o de Login
    fazerLogin,
    
    // CRUD Vendedores
    fetchVendedores,
    adicionarVendedor,
    atualizarVendedor,
    excluirVendedor,
    
    // CRUD Produtos
    fetchProdutos,
    adicionarProduto,
    atualizarProduto,
    excluirProduto,
    
    // CRUD Categorias
    fetchCategorias,
    adicionarCategoria,
    atualizarCategoria,
    excluirCategoria,
    
    // CRUD Consigna√ß√µes
    fetchConsignacoes,
    adicionarConsignacao,
    finalizarConsignacao,
    excluirConsignacao,
    
    // Utilit√°rios
    refetch,
    testarConexao,
    clearError: () => setError(null)
  };
};